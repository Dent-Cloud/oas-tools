{"version":3,"file":"oas-security.js","names":["_","_interopRequireWildcard","require","async","_configurations","_jsonwebtoken","_interopRequireDefault","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","getValue","req","secDef","secName","secReq","propName","name","propLocation","in","value","type","scheme","headers","authorization","query","toLowerCase","sendSecurityError","err","res","next","code","statusCode","each","header","setHeader","removeBasePath","reqRoutePath","split","filter","a","i","config","basePath","join","verifyToken","token","bearerRegex","sendError","sendStatus","test","newToken","replace","jwt","verify","securityFile","algorithms","issuer","error","decoded","_default","specDoc","OASSecurity","handlers","operation","pathsDict","route","path","securityReqs","logger","debug","paths","method","security","length","mapSeries","callback","map","keys","components","securitySchemes","Error","rolesObjArr","element","rolesArr","handler","bearerFormat","isNull","undefined","ok","errors","allowed","message","exports"],"sources":["../../src/middleware/oas-security.js"],"sourcesContent":["import * as _ from \"lodash-compat\";\nimport * as async from \"async\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nvar getValue = (req, secDef, secName, secReq) => {\n  var propName = secDef.name;\n  var propLocation = secDef.in;\n  var value;\n\n  if (secDef.type === \"oauth2\") {\n    value = secReq[secName];\n  } else if (secDef.type === \"http\") {\n    if (secDef.scheme === \"bearer\") {\n      value = req.headers.authorization;\n    }\n  } else if (secDef.type === \"apiKey\") {\n    if (propLocation === \"query\") {\n      value = req.query;\n    } else if (propLocation === \"header\") {\n      value = req.headers[propName.toLowerCase()];\n    }\n  }\n\n  return value;\n};\nvar sendSecurityError = (err, res, next) => {\n  // Populate default values if not present\n  if (!err.code) {\n    err.code = \"server_error\";\n  }\n\n  if (!err.statusCode) {\n    err.statusCode = 403;\n  }\n\n  if (err.headers) {\n    _.each(err.headers, (header, name) => {\n      res.setHeader(name, header);\n    });\n  }\n\n  res.statusCode = err.statusCode;\n  next(err);\n};\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction verifyToken(req, secDef, token, secName, next) {\n  const bearerRegex = /^Bearer\\s/;\n\n  function sendError(statusCode) {\n    return req.res.sendStatus(statusCode);\n  }\n\n  if (token && bearerRegex.test(token)) {\n    var newToken = token.replace(bearerRegex, \"\");\n    jwt.verify(\n      newToken,\n      config.securityFile[secName].key,\n      {\n        algorithms: config.securityFile[secName].algorithms || [\"HS256\"],\n        issuer: config.securityFile[secName].issuer,\n      },\n      (error, decoded) => {\n        if (error === null && decoded) {\n          next();\n          return;\n        }\n        next(sendError(403));\n      }\n    );\n  } else {\n    next(sendError(401));\n  }\n}\n\nexport default (specDoc) => {\n  return function OASSecurity(req, res, next) {\n    var handlers = config.securityFile;\n    var operation = config.pathsDict[removeBasePath(req.route.path)];\n    var securityReqs;\n\n    if (operation) {\n      config.logger.debug(\"Checking security...\");\n      securityReqs =\n        specDoc.paths[operation][req.method.toLowerCase()].security ||\n        specDoc.security;\n\n      if (securityReqs && securityReqs.length > 0) {\n        async.mapSeries(\n          securityReqs,\n          (secReq, callback) => {\n            // logical OR - any one can allow\n            var secName;\n\n            async.map(\n              Object.keys(secReq),\n              (name, callback) => {\n                // logical AND - all must allow\n                var secDef = specDoc.components.securitySchemes[name];\n\n                if (!secDef) {\n                  throw new Error('Undefined \"' + name + '\" security scheme');\n                }\n\n                // start #146, extend the secDef with the array of the securityReq\n                var rolesObjArr = [];\n                for (const i in securityReqs) {\n                  if (securityReqs.hasOwnProperty(i)) {\n                    var element = securityReqs[i];\n                    if (element[name]) {\n                      rolesObjArr = element[name];\n                    }\n                  }\n                }\n                secDef.rolesArr = rolesObjArr;\n                // end #146, of new role adding\n\n                var handler = handlers[name];\n\n                secName = name;\n\n                if (!handler || typeof handler !== \"function\") {\n                  if (\n                    secDef.type === \"http\" &&\n                    secDef.scheme === \"bearer\" &&\n                    secDef.bearerFormat === \"JWT\"\n                  ) {\n                    return verifyToken(\n                      req,\n                      secDef,\n                      req.headers.authorization,\n                      name,\n                      callback\n                    );\n                  }\n                  return callback(\n                    new Error(\n                      \"No handler was specified for security scheme \" + name\n                    )\n                  );\n                }\n\n                return handler(\n                  req,\n                  secDef,\n                  getValue(req, secDef, name, secReq),\n                  callback\n                );\n              },\n              (err) => {\n                config.logger.debug(\n                  \"    Security check \" +\n                    secName +\n                    \": \" +\n                    (_.isNull(err) ? \"allowed\" : \"denied\")\n                );\n\n                // swap normal err and result to short-circuit the logical OR\n                if (err) {\n                  return callback(undefined, err);\n                }\n\n                return callback(new Error(\"OK\"));\n              }\n            );\n          },\n          (ok, errors) => {\n            // note swapped results\n            var allowed = !_.isNull(ok) && ok.message === \"OK\";\n\n            config.logger.debug(\"    Request allowed: \" + allowed);\n\n            if (allowed) {\n              return next();\n            }\n\n            return sendSecurityError(errors[0], res, next);\n          }\n        );\n      } else {\n        return next();\n      }\n    } else {\n      return next();\n    }\n  };\n};\n"],"mappings":"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"}