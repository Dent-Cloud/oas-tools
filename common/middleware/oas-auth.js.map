{"version":3,"file":"oas-auth.js","names":["_accesscontrol","_interopRequireDefault","require","_accesscontrolMiddleware","_configurations","_jsonwebtoken","obj","__esModule","default","removeBasePath","reqRoutePath","split","filter","a","i","config","basePath","join","locationFormat","inProperty","dict","path","query","header","cookie","filterParams","methodParameters","pathParameters","res","paramNames","map","param","name","forEach","pathParam","includes","push","_default","oasDoc","OASAuth","req","next","usedPath","pathsDict","route","method","toLowerCase","logger","debug","securityReqs","paths","security","length","secName","secDef","secReq","Object","keys","find","components","securitySchemes","type","scheme","bearerFormat","grantsFile","ac","AccessControl","accessControlMiddleware","AccessControlMiddleware","action","paramLocation","usedParameter","userProperty","resource","parameters","bearerRegex","token","headers","authorization","replace","decoded","jwt","decode","undefined","parameter","in","checkObject","checkOwnerShip","operands","source","key","user","role","middleware","check","exports"],"sources":["../../src/middleware/oas-auth.js"],"sourcesContent":["import AccessControl from \"accesscontrol\";\nimport AccessControlMiddleware from \"accesscontrol-middleware\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction locationFormat(inProperty) {\n  var dict = {\n    path: \"params\",\n    query: \"query\",\n    header: \"header\",\n    cookie: \"cookie\",\n  };\n  return dict[inProperty];\n}\n\nfunction filterParams(methodParameters, pathParameters) {\n  var res = methodParameters;\n  var paramNames = methodParameters.map((param) => {\n    return param.name;\n  });\n  pathParameters.forEach((pathParam) => {\n    if (!paramNames.includes(pathParam.name)) {\n      res.push(pathParam);\n    }\n  });\n  return res;\n}\n\nexport default (oasDoc) => {\n  return function OASAuth(req, res, next) {\n    const usedPath = config.pathsDict[removeBasePath(req.route.path)];\n    const method = req.method.toLowerCase();\n    config.logger.debug(\"Checking authorization...\");\n    var securityReqs =\n      oasDoc.paths[usedPath][method].security || oasDoc.security;\n\n    if (securityReqs && securityReqs.length > 0) {\n      var secName;\n      var secDef;\n      securityReqs.forEach((secReq) => {\n        secName = Object.keys(secReq).find((name) => {\n          secDef = oasDoc.components.securitySchemes[name];\n          return (\n            secDef.type === \"http\" &&\n            secDef.scheme === \"bearer\" &&\n            secDef.bearerFormat === \"JWT\"\n          );\n        });\n      });\n      if (secName && config.grantsFile[secName]) {\n        const ac = new AccessControl(config.grantsFile[secName]);\n        const accessControlMiddleware = new AccessControlMiddleware(ac);\n        var action;\n        switch (method) {\n          case \"get\":\n            action = \"read\";\n            break;\n          case \"head\":\n            action = \"read\";\n            break;\n          case \"post\":\n            action = \"create\";\n            break;\n          case \"put\":\n            action = \"update\";\n            break;\n          case \"patch\":\n            action = \"update\";\n            break;\n          case \"delete\":\n            action = \"delete\";\n        }\n        var paramLocation, usedParameter, userProperty;\n        var resource = usedPath;\n        var methodParameters = oasDoc.paths[usedPath][method].parameters || [];\n        var pathParameters = oasDoc.paths[usedPath].parameters || [];\n        var parameters = filterParams(methodParameters, pathParameters);\n        const bearerRegex = /^Bearer\\s/;\n        var token = req.headers.authorization.replace(bearerRegex, \"\");\n        var decoded = jwt.decode(token);\n        if (parameters !== undefined) {\n          parameters.forEach((parameter) => {\n            if (parameter[\"x-acl-binding\"]) {\n              usedParameter = parameter.name;\n              userProperty = parameter[\"x-acl-binding\"];\n              paramLocation = locationFormat(parameter.in);\n            } else if (\n              !usedParameter &&\n              parameter.in === \"path\" &&\n              decoded[parameter.name]\n            ) {\n              usedParameter = parameter.name;\n              userProperty = parameter.name;\n              paramLocation = \"params\";\n            }\n          });\n        }\n        var checkObject = {\n          resource: resource,\n          action: action,\n          checkOwnerShip: false,\n        };\n        if (usedParameter) {\n          checkObject.checkOwnerShip = true;\n          checkObject.operands = [\n            {\n              source: \"user\",\n              key: userProperty,\n            },\n            {\n              source: paramLocation,\n              key: usedParameter,\n            },\n          ];\n        }\n        if (!req.user) {\n          req.user = {};\n        }\n        req.user.role = decoded.role || \"anonymous\";\n        req.user[userProperty] = decoded[userProperty] || \"\";\n        var middleware = accessControlMiddleware.check(checkObject);\n        middleware(req, res, next);\n      } else {\n        config.logger.debug(\"No security definition including JWT was found\");\n        return next();\n      }\n    } else {\n      config.logger.debug(\"No security requirements found for this request\");\n      return next();\n    }\n  };\n};\n"],"mappings":"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"}