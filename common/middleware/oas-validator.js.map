{"version":3,"file":"oas-validator.js","names":["_","_interopRequireWildcard","require","utils","_zSchema","_interopRequireDefault","_configurations","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","validator","ZSchema","ignoreUnresolvableReferences","ignoreUnknownFormats","config","breakOnFirstError","locationFormat","inProperty","dict","path","query","header","cookie","filterParams","methodParameters","pathParameters","res","paramNames","map","param","name","forEach","pathParam","includes","push","addFilesToJSONPropertyValidation","files","dataToValidate","data","file","fieldname","originalname","checkBody","req","requestBody","emptyBody","body","undefined","JSON","stringify","required","message","contentType","keys","content","validSchema","cloneDeep","schema","fixNullable","toLowerCase","length","err","validate","error","getLastErrors","logger","info","getRequestProperty","location","requestLocation","find","checkParameter","params","errorMessages","i","in","currentParameter","nullable","Boolean","requestParameter","value","convertValue","getParameterType","code","registeredFormats","getRegisteredFormats","checkRequestData","oasDoc","requestedSpecPath","method","next","paths","keepGoing","msg","methodParams","parameters","pathParams","concat","strict","customErrorHandling","Error","assign","failedValidation","validationResult","status","send","warn","locals","type","getParameterValue","parameter","defaultVal","paramLocation","val","headers","isUndefined","convertArrayValue","arrayValue","parse","Array","isArray","item","index","itemSchema","items","convertBooleanValue","convertNumberValue","numberValue","Number","isNaN","convertObjectValue","convertStringValue","format","date","Date","toString","optionalSchema","optionalType","allowEmptyValue","removeBasePath","reqRoutePath","split","filter","a","basePath","join","_default","OASValidator","url","pathsDict","route","operation","swagger","pType","oVal","originalValue","debug","exports"],"sources":["../../src/middleware/oas-validator.js"],"sourcesContent":["/*!\nOAS-tools module 0.0.0, built on: 2017-03-30\nCopyright (C) 2017 Ignacio Peluaga Lozada (ISA Group)\nhttps://github.com/ignpelloz\nhttps://github.com/isa-group/project-oas-tools\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.*/\n\nimport * as _ from \"lodash-compat\";\nimport * as utils from \"../lib/utils\";\nimport ZSchema from \"z-schema\";\nimport { config } from \"../configurations\";\nconst validator = new ZSchema({\n  ignoreUnresolvableReferences: true,\n  ignoreUnknownFormats: config.ignoreUnknownFormats,\n  breakOnFirstError: false,\n});\n\n/**\n * Returns the Express version of the OAS name for location.\n * @param {string} inProperty - Location of a parameter, value of 'in' property of the oasDoc file for that parameter.\n */\nfunction locationFormat(inProperty) {\n  //TODO: Possible 'in' values: path, query, header, cookie.\n  var dict = {\n    path: \"params\",\n    query: \"query\",\n    header: \"headers\",\n    cookie: \"cookie\",\n  };\n  return dict[inProperty];\n  //return (inProperty == \"path\" ? \"params\" : inProperty); //TODO: if only 'path' changes then this is the solution!\n}\n\n/**\n * Filters path parameters so that method parameters can override them\n * @param {*} methodParameters - Method-specific parameters\n * @param {*} pathParameters - Common parameters for every path method\n */\nfunction filterParams(methodParameters, pathParameters) {\n  var res = methodParameters;\n  var paramNames = methodParameters.map((param) => {\n    return param.name;\n  });\n  pathParameters.forEach((pathParam) => {\n    if (!paramNames.includes(pathParam.name)) {\n      res.push(pathParam);\n    }\n  });\n  return res;\n}\n\n/**\n * transfer fieldname(s) and filename(s) of an multipart/form-data request to a data object\n * that is subsequently passed to a validator checking for required properties of a openAPI path operation\n *\n * @param {array} files\n * @param {object} dataToValidate\n * @returns {object}\n */\nfunction addFilesToJSONPropertyValidation(files, dataToValidate) {\n  const data = dataToValidate;\n  files.forEach((file) => {\n    if (file.fieldname && file.originalname) {\n      data[file.fieldname] = file.originalname;\n    }\n  });\n  return data;\n}\n\nfunction checkBody(req, requestBody) {\n  const emptyBody = req.body == undefined || JSON.stringify(req.body) == \"{}\";\n  if (requestBody.required && emptyBody) {\n    return {\n      message: \"Missing object in the request body. \",\n    };\n  } else if (requestBody.required || !emptyBody) {\n    // can be any of \"application/json\", \"multipart/form-data\", \"image/png\", ...\n    const contentType = Object.keys(requestBody.content)[0];\n    var validSchema = _.cloneDeep(requestBody.content[contentType].schema);\n    utils.fixNullable(validSchema);\n\n    var data = req.body; //JSON.parse(req.body); //Without this everything is string so type validation wouldn't happen TODO: why is it commented?\n    // a multipart/form-data request has a \"files\" property in the request whose\n    // properties need to be passed to evaluating the required parameters in the openAPI spec\n    if (\n      contentType.toLowerCase() === \"multipart/form-data\" &&\n      req.files &&\n      req.files.length > 0\n    ) {\n      data = addFilesToJSONPropertyValidation(req.files, data);\n    }\n    var err = validator.validate(data, validSchema);\n    if (err == false) {\n      return {\n        message: \"Wrong data in the body of the request. \",\n        error: validator.getLastErrors(),\n        content: data,\n      };\n    }\n    config.logger.info(\"Valid parameter on request\");\n  }\n  return undefined;\n}\n\nfunction getRequestProperty(req, location, name) {\n  const requestLocation = req[location];\n  if (location === \"headers\") {\n    return requestLocation[\n      Object.keys(requestLocation).find(\n        (key) => key.toLowerCase() === name.toLowerCase()\n      )\n    ];\n  }\n  return requestLocation[name];\n}\n\nfunction checkParameter(req, params) {\n  const errorMessages = [];\n  for (var i = 0; i < params.length; i++) {\n    //TODO: 'required' property is not required, some parameters may not have it (those in query for example)\n\n    const { name, schema } = params[i];\n    const location = locationFormat(params[i].in);\n    const currentParameter = params[i];\n\n    const nullable =\n      currentParameter.nullable === undefined\n        ? false\n        : Boolean(currentParameter.nullable);\n    const required =\n      currentParameter.required === undefined\n        ? false\n        : Boolean(currentParameter.required);\n\n    const requestParameter = getRequestProperty(req, location, name);\n\n    if (requestParameter === undefined) {\n      if (required) {\n        errorMessages.push({\n          message: \"Missing parameter \" + name + \" in \" + location + \". \",\n        });\n      }\n    } else if (requestParameter === null) {\n      if (nullable === false) {\n        errorMessages.push({\n          message:\n            \"The parameter \" + name + \" in \" + location + \" cannot be null. \",\n        });\n      }\n    } else {\n      // In case the parameter is indeed present, check type. In the case of array, check also type of its items!\n      const value = convertValue(\n        requestParameter,\n        schema,\n        getParameterType(currentParameter),\n        currentParameter\n      );\n      const err = validator.validate(value, schema);\n      if (err == false) {\n        if (err.code == \"UNKNOWN_FORMAT\") {\n          var registeredFormats = ZSchema.getRegisteredFormats();\n          config.logger.error(\"UNKNOWN_FORMAT error - Registered Formats: \");\n          config.logger.error(registeredFormats);\n        }\n        errorMessages.push({\n          message: \"Wrong parameter \" + name + \" in \" + location + \". \",\n          error: validator.getLastErrors(),\n        });\n      } else {\n        config.logger.info(\"Valid parameter on request\");\n      }\n    }\n  }\n  return errorMessages;\n}\n\n/**\n * Checks if the data provided in the request is valid acording to what is specified in the oas specification file.\n * @param {object} paths - Paths section of the oasDoc file.\n * @param {string} requestedSpecPath - Requested url by the client. If the request had parameters in the query those won't be part of this variable.\n * @param {string} method - Method requested by the client.\n * @param {string} req - The whole req object from the client request.\n */\nfunction checkRequestData(oasDoc, requestedSpecPath, method, res, req, next) {\n  var paths = oasDoc.paths;\n  var keepGoing = true;\n  //var msg = \"\";\n  var msg = [];\n\n  if (paths[requestedSpecPath][method].hasOwnProperty(\"requestBody\")) {\n    const message = checkBody(\n      req,\n      paths[requestedSpecPath][method].requestBody\n    );\n    if (message !== undefined) {\n      msg.push(message);\n      keepGoing = false;\n    }\n  }\n\n  if (\n    paths[requestedSpecPath][method].hasOwnProperty(\"parameters\") ||\n    paths[requestedSpecPath].hasOwnProperty(\"parameters\")\n  ) {\n    const methodParams = paths[requestedSpecPath][method].parameters || [];\n    const pathParams = paths[requestedSpecPath].parameters || [];\n    const params = filterParams(methodParams, pathParams);\n    const errorMessages = checkParameter(req, params);\n    if (errorMessages.length !== 0) {\n      msg = msg.concat(errorMessages);\n      keepGoing = false;\n    }\n  }\n\n  if (keepGoing == false && config.strict == true) {\n    if (config.customErrorHandling) {\n      var error = new Error(\"Request validation error\");\n      Object.assign(error, {\n        failedValidation: true,\n        validationResult: msg,\n      });\n      next(error);\n    } else {\n      config.logger.error(JSON.stringify(msg));\n      res.status(400).send(msg);\n    }\n  } else {\n    if (msg.length != 0) {\n      config.logger.warn(JSON.stringify(msg));\n    }\n    res.locals.oasDoc = oasDoc;\n    next();\n  }\n}\n\n/**\n * .\n * @param {string}  - .\n */\nfunction getParameterType(schema) {\n  var type = schema.type;\n  if (!type && schema.schema) {\n    type = getParameterType(schema.schema);\n  }\n  if (!type) {\n    type = \"object\";\n  }\n  return type;\n}\n\n/**\n * .\n * @param {string}  - .\n\nfunction getParameterValue(req, parameter){ //TODO handle: body, form, formData, header, path, query... what about body?\n  var parameterName = parameter.name;\n  return req.params[parameterName];\n}\n*/\nfunction getParameterValue(req, parameter) {\n  var defaultVal = parameter.schema ? parameter.schema.default : undefined;\n  var paramLocation = parameter.in;\n  var val;\n\n  // Get the value to validate based on the operation parameter type\n  switch (paramLocation) {\n    case \"body\":\n      val = req.body;\n\n      break;\n    case \"form\":\n    case \"formData\":\n    case \"header\":\n      val = req.headers[parameter.name.toLowerCase()];\n\n      break;\n    case \"path\":\n      val = req.params[parameter.name]; // TODO: how many parameters can be in the path?\n\n      break;\n    case \"query\":\n      val = _.get(req.query, parameter.name);\n\n      break;\n  }\n  // Use the default value when necessary\n  if (_.isUndefined(val) && !_.isUndefined(defaultVal)) {\n    val = defaultVal;\n  }\n\n  return val;\n}\n\nfunction convertArrayValue(value, schema) {\n  let arrayValue;\n  if (typeof value === \"string\") {\n    try {\n      arrayValue = JSON.parse(value);\n      // Handle situation where the expected type is array but only one value was provided\n      if (Array.isArray(arrayValue) === false) {\n        return [value];\n      }\n    } catch (err) {\n      return value;\n    }\n  }\n\n  return arrayValue.map(value, (item, index) => {\n    const itemSchema = Array.isArray(schema.items)\n      ? schema.items[index]\n      : schema.items;\n\n    return convertValue(\n      item,\n      itemSchema,\n      itemSchema ? itemSchema.type : undefined\n    );\n  });\n}\n\nfunction convertBooleanValue(value) {\n  if (typeof value === \"boolean\") {\n    return value;\n  }\n  if (value === \"true\") {\n    return true;\n  }\n  if (value === \"false\") {\n    return false;\n  }\n  return value;\n}\n\nfunction convertNumberValue(value) {\n  if (typeof value !== \"string\") {\n    return value;\n  }\n  const numberValue = Number(value);\n  if (isNaN(numberValue)) {\n    return value;\n  }\n  return numberValue;\n}\n\nfunction convertObjectValue(value) {\n  if (typeof value !== \"string\") {\n    return value;\n  }\n  try {\n    return JSON.parse(value);\n  } catch (err) {\n    return value;\n  }\n}\n\nfunction convertStringValue(value, schema) {\n  if (typeof value !== \"string\") {\n    return value;\n  }\n\n  if ([\"date\", \"date-time\"].includes(schema.format)) {\n    const date = new Date(value);\n    if (date.toString() === \"Invalid Date\") {\n      return value;\n    }\n    return value;\n  }\n  return value;\n}\n\n/**\n * .\n * @param {string}  - .\n */\nfunction convertValue(value, optionalSchema, optionalType) {\n  // If there is no value, do not convert it\n  if (value === undefined) {\n    return value;\n  }\n  const schema = optionalSchema === undefined ? {} : optionalSchema;\n\n  // If there is an empty value and allowEmptyValue is true, return it\n  if (schema.allowEmptyValue && value === \"\") {\n    return value;\n  }\n  const type =\n    optionalType === undefined ? getParameterType(schema) : optionalType;\n\n  switch (type) {\n    case \"array\":\n      return convertArrayValue(value, schema);\n\n    case \"boolean\":\n      return convertBooleanValue(value);\n\n    case \"integer\":\n    case \"number\":\n      return convertNumberValue(value);\n\n    case \"object\":\n      return convertObjectValue(value);\n\n    case \"string\":\n    default:\n      return convertStringValue(value, schema);\n  }\n}\n\n/**\n * Subtracts the basePath of the requested path.\n * @param {string} reqRoutePath - Value of req.route.path.\n */\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nexport default (oasDoc) => {\n  return function OASValidator(req, res, next) {\n    var method = req.method.toLowerCase();\n\n    config.logger.info(\n      \"Requested method-url pair: \" + method + \" - \" + req.url\n    );\n\n    var requestedSpecPath = config.pathsDict[removeBasePath(req.route.path)];\n    var operation = oasDoc.paths[requestedSpecPath][method];\n\n    req.swagger = {\n      params: {},\n      operation: operation,\n    };\n\n    var methodParameters = operation.parameters || [];\n    var pathParameters = oasDoc.paths[requestedSpecPath].parameters || [];\n    var parameters = filterParams(methodParameters, pathParameters);\n    if (parameters != undefined) {\n      parameters.forEach((parameter) => {\n        // TODO: para POST y PUT el objeto se define en 'requestBody' y no en 'parameters'\n        var pType = getParameterType(parameter);\n        var oVal = getParameterValue(req, parameter);\n        var value = convertValue(\n          oVal,\n          parameter.schema == undefined ? parameter : parameter.schema,\n          pType\n        );\n\n        req.swagger.params[parameter.name] = {\n          // pgillis 2019 June 11\n\n          //path: \"/some/path\", //this shows the path to follow on the spec file to get to the parameter but oas-tools doesn't use it!\n          path: requestedSpecPath,\n          schema: parameter,\n          originalValue: oVal,\n          value: value,\n        };\n      });\n    }\n\n    var requestBody = operation.requestBody;\n    if (requestBody != undefined) {\n      // when and endpoint provides a file upload option and other properties,\n      // the content type changes to multipart/form-data\n      // other requestBody types such as \"image/png\" are allowed as well\n      // https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#considerations-for-file-uploads\n      const contentType = Object.keys(requestBody.content)[0];\n      req.swagger.params[requestBody[\"x-name\"]] = {\n        // pgillis 2019 June 11\n\n        //path: \"/some/path\", //this shows the path to follow on the spec file to get to the parameter but oas-tools doesn't use it!\n        path: requestedSpecPath,\n        schema: requestBody.content[contentType].schema,\n        originalValue: req.body,\n        value: req.body,\n      };\n\n      // inject possible file uploads\n      if (\n        contentType.toLowerCase() === \"multipart/form-data\" &&\n        req.files &&\n        req.files.length > 0\n      ) {\n        req.swagger.params[requestBody[\"x-name\"]].files = req.files;\n      }\n    }\n\n    res.locals.requestedSpecPath = requestedSpecPath;\n    config.logger.debug(\n      \"OASValidator  -res.locals.requestedSpecPath: \" +\n        res.locals.requestedSpecPath\n    );\n    checkRequestData(oasDoc, requestedSpecPath, method, res, req, next);\n  };\n};\n"],"mappings":";;;;;;AAmBA,IAAAA,CAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,KAAA,GAAAF,uBAAA,CAAAC,OAAA;AACA,IAAAE,QAAA,GAAAC,sBAAA,CAAAH,OAAA;AACA,IAAAI,eAAA,GAAAJ,OAAA;AAA2C,SAAAG,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAAA,SAAAG,yBAAAC,WAAA,eAAAC,OAAA,kCAAAC,iBAAA,OAAAD,OAAA,QAAAE,gBAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,WAAA,WAAAA,WAAA,GAAAG,gBAAA,GAAAD,iBAAA,KAAAF,WAAA;AAAA,SAAAV,wBAAAM,GAAA,EAAAI,WAAA,SAAAA,WAAA,IAAAJ,GAAA,IAAAA,GAAA,CAAAC,UAAA,WAAAD,GAAA,QAAAA,GAAA,oBAAAA,GAAA,wBAAAA,GAAA,4BAAAE,OAAA,EAAAF,GAAA,UAAAQ,KAAA,GAAAL,wBAAA,CAAAC,WAAA,OAAAI,KAAA,IAAAA,KAAA,CAAAC,GAAA,CAAAT,GAAA,YAAAQ,KAAA,CAAAE,GAAA,CAAAV,GAAA,SAAAW,MAAA,WAAAC,qBAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,GAAA,IAAAhB,GAAA,QAAAgB,GAAA,kBAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAnB,GAAA,EAAAgB,GAAA,SAAAI,IAAA,GAAAR,qBAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAf,GAAA,EAAAgB,GAAA,cAAAI,IAAA,KAAAA,IAAA,CAAAV,GAAA,IAAAU,IAAA,CAAAC,GAAA,KAAAR,MAAA,CAAAC,cAAA,CAAAH,MAAA,EAAAK,GAAA,EAAAI,IAAA,YAAAT,MAAA,CAAAK,GAAA,IAAAhB,GAAA,CAAAgB,GAAA,SAAAL,MAAA,CAAAT,OAAA,GAAAF,GAAA,MAAAQ,KAAA,IAAAA,KAAA,CAAAa,GAAA,CAAArB,GAAA,EAAAW,MAAA,YAAAA,MAAA;AAtB3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAMA,MAAMW,SAAS,GAAG,IAAIC,gBAAO,CAAC;EAC5BC,4BAA4B,EAAE,IAAI;EAClCC,oBAAoB,EAAEC,sBAAM,CAACD,oBAAoB;EACjDE,iBAAiB,EAAE;AACrB,CAAC,CAAC;;AAEF;AACA;AACA;AACA;AACA,SAASC,cAAcA,CAACC,UAAU,EAAE;EAClC;EACA,IAAIC,IAAI,GAAG;IACTC,IAAI,EAAE,QAAQ;IACdC,KAAK,EAAE,OAAO;IACdC,MAAM,EAAE,SAAS;IACjBC,MAAM,EAAE;EACV,CAAC;EACD,OAAOJ,IAAI,CAACD,UAAU,CAAC;EACvB;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA,SAASM,YAAYA,CAACC,gBAAgB,EAAEC,cAAc,EAAE;EACtD,IAAIC,GAAG,GAAGF,gBAAgB;EAC1B,IAAIG,UAAU,GAAGH,gBAAgB,CAACI,GAAG,CAAEC,KAAK,IAAK;IAC/C,OAAOA,KAAK,CAACC,IAAI;EACnB,CAAC,CAAC;EACFL,cAAc,CAACM,OAAO,CAAEC,SAAS,IAAK;IACpC,IAAI,CAACL,UAAU,CAACM,QAAQ,CAACD,SAAS,CAACF,IAAI,CAAC,EAAE;MACxCJ,GAAG,CAACQ,IAAI,CAACF,SAAS,CAAC;IACrB;EACF,CAAC,CAAC;EACF,OAAON,GAAG;AACZ;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASS,gCAAgCA,CAACC,KAAK,EAAEC,cAAc,EAAE;EAC/D,MAAMC,IAAI,GAAGD,cAAc;EAC3BD,KAAK,CAACL,OAAO,CAAEQ,IAAI,IAAK;IACtB,IAAIA,IAAI,CAACC,SAAS,IAAID,IAAI,CAACE,YAAY,EAAE;MACvCH,IAAI,CAACC,IAAI,CAACC,SAAS,CAAC,GAAGD,IAAI,CAACE,YAAY;IAC1C;EACF,CAAC,CAAC;EACF,OAAOH,IAAI;AACb;AAEA,SAASI,SAASA,CAACC,GAAG,EAAEC,WAAW,EAAE;EACnC,MAAMC,SAAS,GAAGF,GAAG,CAACG,IAAI,IAAIC,SAAS,IAAIC,IAAI,CAACC,SAAS,CAACN,GAAG,CAACG,IAAI,CAAC,IAAI,IAAI;EAC3E,IAAIF,WAAW,CAACM,QAAQ,IAAIL,SAAS,EAAE;IACrC,OAAO;MACLM,OAAO,EAAE;IACX,CAAC;EACH,CAAC,MAAM,IAAIP,WAAW,CAACM,QAAQ,IAAI,CAACL,SAAS,EAAE;IAC7C;IACA,MAAMO,WAAW,GAAGnD,MAAM,CAACoD,IAAI,CAACT,WAAW,CAACU,OAAO,CAAC,CAAC,CAAC,CAAC;IACvD,IAAIC,WAAW,GAAG1E,CAAC,CAAC2E,SAAS,CAACZ,WAAW,CAACU,OAAO,CAACF,WAAW,CAAC,CAACK,MAAM,CAAC;IACtEzE,KAAK,CAAC0E,WAAW,CAACH,WAAW,CAAC;IAE9B,IAAIjB,IAAI,GAAGK,GAAG,CAACG,IAAI,CAAC,CAAC;IACrB;IACA;IACA,IACEM,WAAW,CAACO,WAAW,CAAC,CAAC,KAAK,qBAAqB,IACnDhB,GAAG,CAACP,KAAK,IACTO,GAAG,CAACP,KAAK,CAACwB,MAAM,GAAG,CAAC,EACpB;MACAtB,IAAI,GAAGH,gCAAgC,CAACQ,GAAG,CAACP,KAAK,EAAEE,IAAI,CAAC;IAC1D;IACA,IAAIuB,GAAG,GAAGnD,SAAS,CAACoD,QAAQ,CAACxB,IAAI,EAAEiB,WAAW,CAAC;IAC/C,IAAIM,GAAG,IAAI,KAAK,EAAE;MAChB,OAAO;QACLV,OAAO,EAAE,yCAAyC;QAClDY,KAAK,EAAErD,SAAS,CAACsD,aAAa,CAAC,CAAC;QAChCV,OAAO,EAAEhB;MACX,CAAC;IACH;IACAxB,sBAAM,CAACmD,MAAM,CAACC,IAAI,CAAC,4BAA4B,CAAC;EAClD;EACA,OAAOnB,SAAS;AAClB;AAEA,SAASoB,kBAAkBA,CAACxB,GAAG,EAAEyB,QAAQ,EAAEtC,IAAI,EAAE;EAC/C,MAAMuC,eAAe,GAAG1B,GAAG,CAACyB,QAAQ,CAAC;EACrC,IAAIA,QAAQ,KAAK,SAAS,EAAE;IAC1B,OAAOC,eAAe,CACpBpE,MAAM,CAACoD,IAAI,CAACgB,eAAe,CAAC,CAACC,IAAI,CAC9BlE,GAAG,IAAKA,GAAG,CAACuD,WAAW,CAAC,CAAC,KAAK7B,IAAI,CAAC6B,WAAW,CAAC,CAClD,CAAC,CACF;EACH;EACA,OAAOU,eAAe,CAACvC,IAAI,CAAC;AAC9B;AAEA,SAASyC,cAAcA,CAAC5B,GAAG,EAAE6B,MAAM,EAAE;EACnC,MAAMC,aAAa,GAAG,EAAE;EACxB,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGF,MAAM,CAACZ,MAAM,EAAEc,CAAC,EAAE,EAAE;IACtC;;IAEA,MAAM;MAAE5C,IAAI;MAAE2B;IAAO,CAAC,GAAGe,MAAM,CAACE,CAAC,CAAC;IAClC,MAAMN,QAAQ,GAAGpD,cAAc,CAACwD,MAAM,CAACE,CAAC,CAAC,CAACC,EAAE,CAAC;IAC7C,MAAMC,gBAAgB,GAAGJ,MAAM,CAACE,CAAC,CAAC;IAElC,MAAMG,QAAQ,GACZD,gBAAgB,CAACC,QAAQ,KAAK9B,SAAS,GACnC,KAAK,GACL+B,OAAO,CAACF,gBAAgB,CAACC,QAAQ,CAAC;IACxC,MAAM3B,QAAQ,GACZ0B,gBAAgB,CAAC1B,QAAQ,KAAKH,SAAS,GACnC,KAAK,GACL+B,OAAO,CAACF,gBAAgB,CAAC1B,QAAQ,CAAC;IAExC,MAAM6B,gBAAgB,GAAGZ,kBAAkB,CAACxB,GAAG,EAAEyB,QAAQ,EAAEtC,IAAI,CAAC;IAEhE,IAAIiD,gBAAgB,KAAKhC,SAAS,EAAE;MAClC,IAAIG,QAAQ,EAAE;QACZuB,aAAa,CAACvC,IAAI,CAAC;UACjBiB,OAAO,EAAE,oBAAoB,GAAGrB,IAAI,GAAG,MAAM,GAAGsC,QAAQ,GAAG;QAC7D,CAAC,CAAC;MACJ;IACF,CAAC,MAAM,IAAIW,gBAAgB,KAAK,IAAI,EAAE;MACpC,IAAIF,QAAQ,KAAK,KAAK,EAAE;QACtBJ,aAAa,CAACvC,IAAI,CAAC;UACjBiB,OAAO,EACL,gBAAgB,GAAGrB,IAAI,GAAG,MAAM,GAAGsC,QAAQ,GAAG;QAClD,CAAC,CAAC;MACJ;IACF,CAAC,MAAM;MACL;MACA,MAAMY,KAAK,GAAGC,YAAY,CACxBF,gBAAgB,EAChBtB,MAAM,EACNyB,gBAAgB,CAACN,gBAAgB,CAAC,EAClCA,gBACF,CAAC;MACD,MAAMf,GAAG,GAAGnD,SAAS,CAACoD,QAAQ,CAACkB,KAAK,EAAEvB,MAAM,CAAC;MAC7C,IAAII,GAAG,IAAI,KAAK,EAAE;QAChB,IAAIA,GAAG,CAACsB,IAAI,IAAI,gBAAgB,EAAE;UAChC,IAAIC,iBAAiB,GAAGzE,gBAAO,CAAC0E,oBAAoB,CAAC,CAAC;UACtDvE,sBAAM,CAACmD,MAAM,CAACF,KAAK,CAAC,6CAA6C,CAAC;UAClEjD,sBAAM,CAACmD,MAAM,CAACF,KAAK,CAACqB,iBAAiB,CAAC;QACxC;QACAX,aAAa,CAACvC,IAAI,CAAC;UACjBiB,OAAO,EAAE,kBAAkB,GAAGrB,IAAI,GAAG,MAAM,GAAGsC,QAAQ,GAAG,IAAI;UAC7DL,KAAK,EAAErD,SAAS,CAACsD,aAAa,CAAC;QACjC,CAAC,CAAC;MACJ,CAAC,MAAM;QACLlD,sBAAM,CAACmD,MAAM,CAACC,IAAI,CAAC,4BAA4B,CAAC;MAClD;IACF;EACF;EACA,OAAOO,aAAa;AACtB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASa,gBAAgBA,CAACC,MAAM,EAAEC,iBAAiB,EAAEC,MAAM,EAAE/D,GAAG,EAAEiB,GAAG,EAAE+C,IAAI,EAAE;EAC3E,IAAIC,KAAK,GAAGJ,MAAM,CAACI,KAAK;EACxB,IAAIC,SAAS,GAAG,IAAI;EACpB;EACA,IAAIC,GAAG,GAAG,EAAE;EAEZ,IAAIF,KAAK,CAACH,iBAAiB,CAAC,CAACC,MAAM,CAAC,CAACnF,cAAc,CAAC,aAAa,CAAC,EAAE;IAClE,MAAM6C,OAAO,GAAGT,SAAS,CACvBC,GAAG,EACHgD,KAAK,CAACH,iBAAiB,CAAC,CAACC,MAAM,CAAC,CAAC7C,WACnC,CAAC;IACD,IAAIO,OAAO,KAAKJ,SAAS,EAAE;MACzB8C,GAAG,CAAC3D,IAAI,CAACiB,OAAO,CAAC;MACjByC,SAAS,GAAG,KAAK;IACnB;EACF;EAEA,IACED,KAAK,CAACH,iBAAiB,CAAC,CAACC,MAAM,CAAC,CAACnF,cAAc,CAAC,YAAY,CAAC,IAC7DqF,KAAK,CAACH,iBAAiB,CAAC,CAAClF,cAAc,CAAC,YAAY,CAAC,EACrD;IACA,MAAMwF,YAAY,GAAGH,KAAK,CAACH,iBAAiB,CAAC,CAACC,MAAM,CAAC,CAACM,UAAU,IAAI,EAAE;IACtE,MAAMC,UAAU,GAAGL,KAAK,CAACH,iBAAiB,CAAC,CAACO,UAAU,IAAI,EAAE;IAC5D,MAAMvB,MAAM,GAAGjD,YAAY,CAACuE,YAAY,EAAEE,UAAU,CAAC;IACrD,MAAMvB,aAAa,GAAGF,cAAc,CAAC5B,GAAG,EAAE6B,MAAM,CAAC;IACjD,IAAIC,aAAa,CAACb,MAAM,KAAK,CAAC,EAAE;MAC9BiC,GAAG,GAAGA,GAAG,CAACI,MAAM,CAACxB,aAAa,CAAC;MAC/BmB,SAAS,GAAG,KAAK;IACnB;EACF;EAEA,IAAIA,SAAS,IAAI,KAAK,IAAI9E,sBAAM,CAACoF,MAAM,IAAI,IAAI,EAAE;IAC/C,IAAIpF,sBAAM,CAACqF,mBAAmB,EAAE;MAC9B,IAAIpC,KAAK,GAAG,IAAIqC,KAAK,CAAC,0BAA0B,CAAC;MACjDnG,MAAM,CAACoG,MAAM,CAACtC,KAAK,EAAE;QACnBuC,gBAAgB,EAAE,IAAI;QACtBC,gBAAgB,EAAEV;MACpB,CAAC,CAAC;MACFH,IAAI,CAAC3B,KAAK,CAAC;IACb,CAAC,MAAM;MACLjD,sBAAM,CAACmD,MAAM,CAACF,KAAK,CAACf,IAAI,CAACC,SAAS,CAAC4C,GAAG,CAAC,CAAC;MACxCnE,GAAG,CAAC8E,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAACZ,GAAG,CAAC;IAC3B;EACF,CAAC,MAAM;IACL,IAAIA,GAAG,CAACjC,MAAM,IAAI,CAAC,EAAE;MACnB9C,sBAAM,CAACmD,MAAM,CAACyC,IAAI,CAAC1D,IAAI,CAACC,SAAS,CAAC4C,GAAG,CAAC,CAAC;IACzC;IACAnE,GAAG,CAACiF,MAAM,CAACpB,MAAM,GAAGA,MAAM;IAC1BG,IAAI,CAAC,CAAC;EACR;AACF;;AAEA;AACA;AACA;AACA;AACA,SAASR,gBAAgBA,CAACzB,MAAM,EAAE;EAChC,IAAImD,IAAI,GAAGnD,MAAM,CAACmD,IAAI;EACtB,IAAI,CAACA,IAAI,IAAInD,MAAM,CAACA,MAAM,EAAE;IAC1BmD,IAAI,GAAG1B,gBAAgB,CAACzB,MAAM,CAACA,MAAM,CAAC;EACxC;EACA,IAAI,CAACmD,IAAI,EAAE;IACTA,IAAI,GAAG,QAAQ;EACjB;EACA,OAAOA,IAAI;AACb;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASC,iBAAiBA,CAAClE,GAAG,EAAEmE,SAAS,EAAE;EACzC,IAAIC,UAAU,GAAGD,SAAS,CAACrD,MAAM,GAAGqD,SAAS,CAACrD,MAAM,CAACnE,OAAO,GAAGyD,SAAS;EACxE,IAAIiE,aAAa,GAAGF,SAAS,CAACnC,EAAE;EAChC,IAAIsC,GAAG;;EAEP;EACA,QAAQD,aAAa;IACnB,KAAK,MAAM;MACTC,GAAG,GAAGtE,GAAG,CAACG,IAAI;MAEd;IACF,KAAK,MAAM;IACX,KAAK,UAAU;IACf,KAAK,QAAQ;MACXmE,GAAG,GAAGtE,GAAG,CAACuE,OAAO,CAACJ,SAAS,CAAChF,IAAI,CAAC6B,WAAW,CAAC,CAAC,CAAC;MAE/C;IACF,KAAK,MAAM;MACTsD,GAAG,GAAGtE,GAAG,CAAC6B,MAAM,CAACsC,SAAS,CAAChF,IAAI,CAAC,CAAC,CAAC;;MAElC;IACF,KAAK,OAAO;MACVmF,GAAG,GAAGpI,CAAC,CAACiB,GAAG,CAAC6C,GAAG,CAACvB,KAAK,EAAE0F,SAAS,CAAChF,IAAI,CAAC;MAEtC;EACJ;EACA;EACA,IAAIjD,CAAC,CAACsI,WAAW,CAACF,GAAG,CAAC,IAAI,CAACpI,CAAC,CAACsI,WAAW,CAACJ,UAAU,CAAC,EAAE;IACpDE,GAAG,GAAGF,UAAU;EAClB;EAEA,OAAOE,GAAG;AACZ;AAEA,SAASG,iBAAiBA,CAACpC,KAAK,EAAEvB,MAAM,EAAE;EACxC,IAAI4D,UAAU;EACd,IAAI,OAAOrC,KAAK,KAAK,QAAQ,EAAE;IAC7B,IAAI;MACFqC,UAAU,GAAGrE,IAAI,CAACsE,KAAK,CAACtC,KAAK,CAAC;MAC9B;MACA,IAAIuC,KAAK,CAACC,OAAO,CAACH,UAAU,CAAC,KAAK,KAAK,EAAE;QACvC,OAAO,CAACrC,KAAK,CAAC;MAChB;IACF,CAAC,CAAC,OAAOnB,GAAG,EAAE;MACZ,OAAOmB,KAAK;IACd;EACF;EAEA,OAAOqC,UAAU,CAACzF,GAAG,CAACoD,KAAK,EAAE,CAACyC,IAAI,EAAEC,KAAK,KAAK;IAC5C,MAAMC,UAAU,GAAGJ,KAAK,CAACC,OAAO,CAAC/D,MAAM,CAACmE,KAAK,CAAC,GAC1CnE,MAAM,CAACmE,KAAK,CAACF,KAAK,CAAC,GACnBjE,MAAM,CAACmE,KAAK;IAEhB,OAAO3C,YAAY,CACjBwC,IAAI,EACJE,UAAU,EACVA,UAAU,GAAGA,UAAU,CAACf,IAAI,GAAG7D,SACjC,CAAC;EACH,CAAC,CAAC;AACJ;AAEA,SAAS8E,mBAAmBA,CAAC7C,KAAK,EAAE;EAClC,IAAI,OAAOA,KAAK,KAAK,SAAS,EAAE;IAC9B,OAAOA,KAAK;EACd;EACA,IAAIA,KAAK,KAAK,MAAM,EAAE;IACpB,OAAO,IAAI;EACb;EACA,IAAIA,KAAK,KAAK,OAAO,EAAE;IACrB,OAAO,KAAK;EACd;EACA,OAAOA,KAAK;AACd;AAEA,SAAS8C,kBAAkBA,CAAC9C,KAAK,EAAE;EACjC,IAAI,OAAOA,KAAK,KAAK,QAAQ,EAAE;IAC7B,OAAOA,KAAK;EACd;EACA,MAAM+C,WAAW,GAAGC,MAAM,CAAChD,KAAK,CAAC;EACjC,IAAIiD,KAAK,CAACF,WAAW,CAAC,EAAE;IACtB,OAAO/C,KAAK;EACd;EACA,OAAO+C,WAAW;AACpB;AAEA,SAASG,kBAAkBA,CAAClD,KAAK,EAAE;EACjC,IAAI,OAAOA,KAAK,KAAK,QAAQ,EAAE;IAC7B,OAAOA,KAAK;EACd;EACA,IAAI;IACF,OAAOhC,IAAI,CAACsE,KAAK,CAACtC,KAAK,CAAC;EAC1B,CAAC,CAAC,OAAOnB,GAAG,EAAE;IACZ,OAAOmB,KAAK;EACd;AACF;AAEA,SAASmD,kBAAkBA,CAACnD,KAAK,EAAEvB,MAAM,EAAE;EACzC,IAAI,OAAOuB,KAAK,KAAK,QAAQ,EAAE;IAC7B,OAAOA,KAAK;EACd;EAEA,IAAI,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC/C,QAAQ,CAACwB,MAAM,CAAC2E,MAAM,CAAC,EAAE;IACjD,MAAMC,IAAI,GAAG,IAAIC,IAAI,CAACtD,KAAK,CAAC;IAC5B,IAAIqD,IAAI,CAACE,QAAQ,CAAC,CAAC,KAAK,cAAc,EAAE;MACtC,OAAOvD,KAAK;IACd;IACA,OAAOA,KAAK;EACd;EACA,OAAOA,KAAK;AACd;;AAEA;AACA;AACA;AACA;AACA,SAASC,YAAYA,CAACD,KAAK,EAAEwD,cAAc,EAAEC,YAAY,EAAE;EACzD;EACA,IAAIzD,KAAK,KAAKjC,SAAS,EAAE;IACvB,OAAOiC,KAAK;EACd;EACA,MAAMvB,MAAM,GAAG+E,cAAc,KAAKzF,SAAS,GAAG,CAAC,CAAC,GAAGyF,cAAc;;EAEjE;EACA,IAAI/E,MAAM,CAACiF,eAAe,IAAI1D,KAAK,KAAK,EAAE,EAAE;IAC1C,OAAOA,KAAK;EACd;EACA,MAAM4B,IAAI,GACR6B,YAAY,KAAK1F,SAAS,GAAGmC,gBAAgB,CAACzB,MAAM,CAAC,GAAGgF,YAAY;EAEtE,QAAQ7B,IAAI;IACV,KAAK,OAAO;MACV,OAAOQ,iBAAiB,CAACpC,KAAK,EAAEvB,MAAM,CAAC;IAEzC,KAAK,SAAS;MACZ,OAAOoE,mBAAmB,CAAC7C,KAAK,CAAC;IAEnC,KAAK,SAAS;IACd,KAAK,QAAQ;MACX,OAAO8C,kBAAkB,CAAC9C,KAAK,CAAC;IAElC,KAAK,QAAQ;MACX,OAAOkD,kBAAkB,CAAClD,KAAK,CAAC;IAElC,KAAK,QAAQ;IACb;MACE,OAAOmD,kBAAkB,CAACnD,KAAK,EAAEvB,MAAM,CAAC;EAC5C;AACF;;AAEA;AACA;AACA;AACA;AACA,SAASkF,cAAcA,CAACC,YAAY,EAAE;EACpC,OAAOA,YAAY,CAChBC,KAAK,CAAC,EAAE,CAAC,CACTC,MAAM,CAAC,CAACC,CAAC,EAAErE,CAAC,KAAK;IAChB,OAAOqE,CAAC,KAAKjI,sBAAM,CAACkI,QAAQ,CAACtE,CAAC,CAAC;EACjC,CAAC,CAAC,CACDuE,IAAI,CAAC,EAAE,CAAC;AACb;AAAC,IAAAC,QAAA,GAEe3D,MAAM,IAAK;EACzB,OAAO,SAAS4D,YAAYA,CAACxG,GAAG,EAAEjB,GAAG,EAAEgE,IAAI,EAAE;IAC3C,IAAID,MAAM,GAAG9C,GAAG,CAAC8C,MAAM,CAAC9B,WAAW,CAAC,CAAC;IAErC7C,sBAAM,CAACmD,MAAM,CAACC,IAAI,CAChB,6BAA6B,GAAGuB,MAAM,GAAG,KAAK,GAAG9C,GAAG,CAACyG,GACvD,CAAC;IAED,IAAI5D,iBAAiB,GAAG1E,sBAAM,CAACuI,SAAS,CAACV,cAAc,CAAChG,GAAG,CAAC2G,KAAK,CAACnI,IAAI,CAAC,CAAC;IACxE,IAAIoI,SAAS,GAAGhE,MAAM,CAACI,KAAK,CAACH,iBAAiB,CAAC,CAACC,MAAM,CAAC;IAEvD9C,GAAG,CAAC6G,OAAO,GAAG;MACZhF,MAAM,EAAE,CAAC,CAAC;MACV+E,SAAS,EAAEA;IACb,CAAC;IAED,IAAI/H,gBAAgB,GAAG+H,SAAS,CAACxD,UAAU,IAAI,EAAE;IACjD,IAAItE,cAAc,GAAG8D,MAAM,CAACI,KAAK,CAACH,iBAAiB,CAAC,CAACO,UAAU,IAAI,EAAE;IACrE,IAAIA,UAAU,GAAGxE,YAAY,CAACC,gBAAgB,EAAEC,cAAc,CAAC;IAC/D,IAAIsE,UAAU,IAAIhD,SAAS,EAAE;MAC3BgD,UAAU,CAAChE,OAAO,CAAE+E,SAAS,IAAK;QAChC;QACA,IAAI2C,KAAK,GAAGvE,gBAAgB,CAAC4B,SAAS,CAAC;QACvC,IAAI4C,IAAI,GAAG7C,iBAAiB,CAAClE,GAAG,EAAEmE,SAAS,CAAC;QAC5C,IAAI9B,KAAK,GAAGC,YAAY,CACtByE,IAAI,EACJ5C,SAAS,CAACrD,MAAM,IAAIV,SAAS,GAAG+D,SAAS,GAAGA,SAAS,CAACrD,MAAM,EAC5DgG,KACF,CAAC;QAED9G,GAAG,CAAC6G,OAAO,CAAChF,MAAM,CAACsC,SAAS,CAAChF,IAAI,CAAC,GAAG;UACnC;;UAEA;UACAX,IAAI,EAAEqE,iBAAiB;UACvB/B,MAAM,EAAEqD,SAAS;UACjB6C,aAAa,EAAED,IAAI;UACnB1E,KAAK,EAAEA;QACT,CAAC;MACH,CAAC,CAAC;IACJ;IAEA,IAAIpC,WAAW,GAAG2G,SAAS,CAAC3G,WAAW;IACvC,IAAIA,WAAW,IAAIG,SAAS,EAAE;MAC5B;MACA;MACA;MACA;MACA,MAAMK,WAAW,GAAGnD,MAAM,CAACoD,IAAI,CAACT,WAAW,CAACU,OAAO,CAAC,CAAC,CAAC,CAAC;MACvDX,GAAG,CAAC6G,OAAO,CAAChF,MAAM,CAAC5B,WAAW,CAAC,QAAQ,CAAC,CAAC,GAAG;QAC1C;;QAEA;QACAzB,IAAI,EAAEqE,iBAAiB;QACvB/B,MAAM,EAAEb,WAAW,CAACU,OAAO,CAACF,WAAW,CAAC,CAACK,MAAM;QAC/CkG,aAAa,EAAEhH,GAAG,CAACG,IAAI;QACvBkC,KAAK,EAAErC,GAAG,CAACG;MACb,CAAC;;MAED;MACA,IACEM,WAAW,CAACO,WAAW,CAAC,CAAC,KAAK,qBAAqB,IACnDhB,GAAG,CAACP,KAAK,IACTO,GAAG,CAACP,KAAK,CAACwB,MAAM,GAAG,CAAC,EACpB;QACAjB,GAAG,CAAC6G,OAAO,CAAChF,MAAM,CAAC5B,WAAW,CAAC,QAAQ,CAAC,CAAC,CAACR,KAAK,GAAGO,GAAG,CAACP,KAAK;MAC7D;IACF;IAEAV,GAAG,CAACiF,MAAM,CAACnB,iBAAiB,GAAGA,iBAAiB;IAChD1E,sBAAM,CAACmD,MAAM,CAAC2F,KAAK,CACjB,+CAA+C,GAC7ClI,GAAG,CAACiF,MAAM,CAACnB,iBACf,CAAC;IACDF,gBAAgB,CAACC,MAAM,EAAEC,iBAAiB,EAAEC,MAAM,EAAE/D,GAAG,EAAEiB,GAAG,EAAE+C,IAAI,CAAC;EACrE,CAAC;AACH,CAAC;AAAAmE,OAAA,CAAAvK,OAAA,GAAA4J,QAAA"}