{"version":3,"file":"oas-security.mjs","names":["_","async","config","jwt","getValue","req","secDef","secName","secReq","propName","name","propLocation","in","value","type","scheme","headers","authorization","query","toLowerCase","sendSecurityError","err","res","next","code","statusCode","each","header","setHeader","removeBasePath","reqRoutePath","split","filter","a","i","basePath","join","verifyToken","token","bearerRegex","sendError","sendStatus","test","newToken","replace","verify","securityFile","key","algorithms","issuer","error","decoded","specDoc","OASSecurity","handlers","operation","pathsDict","route","path","securityReqs","logger","debug","paths","method","security","length","mapSeries","callback","map","Object","keys","components","securitySchemes","Error","rolesObjArr","hasOwnProperty","element","rolesArr","handler","bearerFormat","isNull","undefined","ok","errors","allowed","message"],"sources":["../../src/middleware/oas-security.js"],"sourcesContent":["import * as _ from \"lodash-compat\";\nimport * as async from \"async\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nvar getValue = (req, secDef, secName, secReq) => {\n  var propName = secDef.name;\n  var propLocation = secDef.in;\n  var value;\n\n  if (secDef.type === \"oauth2\") {\n    value = secReq[secName];\n  } else if (secDef.type === \"http\") {\n    if (secDef.scheme === \"bearer\") {\n      value = req.headers.authorization;\n    }\n  } else if (secDef.type === \"apiKey\") {\n    if (propLocation === \"query\") {\n      value = req.query;\n    } else if (propLocation === \"header\") {\n      value = req.headers[propName.toLowerCase()];\n    }\n  }\n\n  return value;\n};\nvar sendSecurityError = (err, res, next) => {\n  // Populate default values if not present\n  if (!err.code) {\n    err.code = \"server_error\";\n  }\n\n  if (!err.statusCode) {\n    err.statusCode = 403;\n  }\n\n  if (err.headers) {\n    _.each(err.headers, (header, name) => {\n      res.setHeader(name, header);\n    });\n  }\n\n  res.statusCode = err.statusCode;\n  next(err);\n};\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction verifyToken(req, secDef, token, secName, next) {\n  const bearerRegex = /^Bearer\\s/;\n\n  function sendError(statusCode) {\n    return req.res.sendStatus(statusCode);\n  }\n\n  if (token && bearerRegex.test(token)) {\n    var newToken = token.replace(bearerRegex, \"\");\n    jwt.verify(\n      newToken,\n      config.securityFile[secName].key,\n      {\n        algorithms: config.securityFile[secName].algorithms || [\"HS256\"],\n        issuer: config.securityFile[secName].issuer,\n      },\n      (error, decoded) => {\n        if (error === null && decoded) {\n          next();\n          return;\n        }\n        next(sendError(403));\n      }\n    );\n  } else {\n    next(sendError(401));\n  }\n}\n\nexport default (specDoc) => {\n  return function OASSecurity(req, res, next) {\n    var handlers = config.securityFile;\n    var operation = config.pathsDict[removeBasePath(req.route.path)];\n    var securityReqs;\n\n    if (operation) {\n      config.logger.debug(\"Checking security...\");\n      securityReqs =\n        specDoc.paths[operation][req.method.toLowerCase()].security ||\n        specDoc.security;\n\n      if (securityReqs && securityReqs.length > 0) {\n        async.mapSeries(\n          securityReqs,\n          (secReq, callback) => {\n            // logical OR - any one can allow\n            var secName;\n\n            async.map(\n              Object.keys(secReq),\n              (name, callback) => {\n                // logical AND - all must allow\n                var secDef = specDoc.components.securitySchemes[name];\n\n                if (!secDef) {\n                  throw new Error('Undefined \"' + name + '\" security scheme');\n                }\n\n                // start #146, extend the secDef with the array of the securityReq\n                var rolesObjArr = [];\n                for (const i in securityReqs) {\n                  if (securityReqs.hasOwnProperty(i)) {\n                    var element = securityReqs[i];\n                    if (element[name]) {\n                      rolesObjArr = element[name];\n                    }\n                  }\n                }\n                secDef.rolesArr = rolesObjArr;\n                // end #146, of new role adding\n\n                var handler = handlers[name];\n\n                secName = name;\n\n                if (!handler || typeof handler !== \"function\") {\n                  if (\n                    secDef.type === \"http\" &&\n                    secDef.scheme === \"bearer\" &&\n                    secDef.bearerFormat === \"JWT\"\n                  ) {\n                    return verifyToken(\n                      req,\n                      secDef,\n                      req.headers.authorization,\n                      name,\n                      callback\n                    );\n                  }\n                  return callback(\n                    new Error(\n                      \"No handler was specified for security scheme \" + name\n                    )\n                  );\n                }\n\n                return handler(\n                  req,\n                  secDef,\n                  getValue(req, secDef, name, secReq),\n                  callback\n                );\n              },\n              (err) => {\n                config.logger.debug(\n                  \"    Security check \" +\n                    secName +\n                    \": \" +\n                    (_.isNull(err) ? \"allowed\" : \"denied\")\n                );\n\n                // swap normal err and result to short-circuit the logical OR\n                if (err) {\n                  return callback(undefined, err);\n                }\n\n                return callback(new Error(\"OK\"));\n              }\n            );\n          },\n          (ok, errors) => {\n            // note swapped results\n            var allowed = !_.isNull(ok) && ok.message === \"OK\";\n\n            config.logger.debug(\"    Request allowed: \" + allowed);\n\n            if (allowed) {\n              return next();\n            }\n\n            return sendSecurityError(errors[0], res, next);\n          }\n        );\n      } else {\n        return next();\n      }\n    } else {\n      return next();\n    }\n  };\n};\n"],"mappings":"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"}