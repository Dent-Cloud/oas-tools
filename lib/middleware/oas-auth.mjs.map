{"version":3,"file":"oas-auth.mjs","names":["AccessControl","AccessControlMiddleware","config","jwt","removeBasePath","reqRoutePath","split","filter","a","i","basePath","join","locationFormat","inProperty","dict","path","query","header","cookie","filterParams","methodParameters","pathParameters","res","paramNames","map","param","name","forEach","pathParam","includes","push","oasDoc","OASAuth","req","next","usedPath","pathsDict","route","method","toLowerCase","logger","debug","securityReqs","paths","security","length","secName","secDef","secReq","Object","keys","find","components","securitySchemes","type","scheme","bearerFormat","grantsFile","ac","accessControlMiddleware","action","paramLocation","usedParameter","userProperty","resource","parameters","bearerRegex","token","headers","authorization","replace","decoded","decode","undefined","parameter","in","checkObject","checkOwnerShip","operands","source","key","user","role","middleware","check"],"sources":["../../src/middleware/oas-auth.js"],"sourcesContent":["import AccessControl from \"accesscontrol\";\nimport AccessControlMiddleware from \"accesscontrol-middleware\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction locationFormat(inProperty) {\n  var dict = {\n    path: \"params\",\n    query: \"query\",\n    header: \"header\",\n    cookie: \"cookie\",\n  };\n  return dict[inProperty];\n}\n\nfunction filterParams(methodParameters, pathParameters) {\n  var res = methodParameters;\n  var paramNames = methodParameters.map((param) => {\n    return param.name;\n  });\n  pathParameters.forEach((pathParam) => {\n    if (!paramNames.includes(pathParam.name)) {\n      res.push(pathParam);\n    }\n  });\n  return res;\n}\n\nexport default (oasDoc) => {\n  return function OASAuth(req, res, next) {\n    const usedPath = config.pathsDict[removeBasePath(req.route.path)];\n    const method = req.method.toLowerCase();\n    config.logger.debug(\"Checking authorization...\");\n    var securityReqs =\n      oasDoc.paths[usedPath][method].security || oasDoc.security;\n\n    if (securityReqs && securityReqs.length > 0) {\n      var secName;\n      var secDef;\n      securityReqs.forEach((secReq) => {\n        secName = Object.keys(secReq).find((name) => {\n          secDef = oasDoc.components.securitySchemes[name];\n          return (\n            secDef.type === \"http\" &&\n            secDef.scheme === \"bearer\" &&\n            secDef.bearerFormat === \"JWT\"\n          );\n        });\n      });\n      if (secName && config.grantsFile[secName]) {\n        const ac = new AccessControl(config.grantsFile[secName]);\n        const accessControlMiddleware = new AccessControlMiddleware(ac);\n        var action;\n        switch (method) {\n          case \"get\":\n            action = \"read\";\n            break;\n          case \"head\":\n            action = \"read\";\n            break;\n          case \"post\":\n            action = \"create\";\n            break;\n          case \"put\":\n            action = \"update\";\n            break;\n          case \"patch\":\n            action = \"update\";\n            break;\n          case \"delete\":\n            action = \"delete\";\n        }\n        var paramLocation, usedParameter, userProperty;\n        var resource = usedPath;\n        var methodParameters = oasDoc.paths[usedPath][method].parameters || [];\n        var pathParameters = oasDoc.paths[usedPath].parameters || [];\n        var parameters = filterParams(methodParameters, pathParameters);\n        const bearerRegex = /^Bearer\\s/;\n        var token = req.headers.authorization.replace(bearerRegex, \"\");\n        var decoded = jwt.decode(token);\n        if (parameters !== undefined) {\n          parameters.forEach((parameter) => {\n            if (parameter[\"x-acl-binding\"]) {\n              usedParameter = parameter.name;\n              userProperty = parameter[\"x-acl-binding\"];\n              paramLocation = locationFormat(parameter.in);\n            } else if (\n              !usedParameter &&\n              parameter.in === \"path\" &&\n              decoded[parameter.name]\n            ) {\n              usedParameter = parameter.name;\n              userProperty = parameter.name;\n              paramLocation = \"params\";\n            }\n          });\n        }\n        var checkObject = {\n          resource: resource,\n          action: action,\n          checkOwnerShip: false,\n        };\n        if (usedParameter) {\n          checkObject.checkOwnerShip = true;\n          checkObject.operands = [\n            {\n              source: \"user\",\n              key: userProperty,\n            },\n            {\n              source: paramLocation,\n              key: usedParameter,\n            },\n          ];\n        }\n        if (!req.user) {\n          req.user = {};\n        }\n        req.user.role = decoded.role || \"anonymous\";\n        req.user[userProperty] = decoded[userProperty] || \"\";\n        var middleware = accessControlMiddleware.check(checkObject);\n        middleware(req, res, next);\n      } else {\n        config.logger.debug(\"No security definition including JWT was found\");\n        return next();\n      }\n    } else {\n      config.logger.debug(\"No security requirements found for this request\");\n      return next();\n    }\n  };\n};\n"],"mappings":"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"}