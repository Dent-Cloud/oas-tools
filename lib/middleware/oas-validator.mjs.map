{"version":3,"file":"oas-validator.mjs","names":["_","utils","ZSchema","config","validator","ignoreUnresolvableReferences","ignoreUnknownFormats","breakOnFirstError","locationFormat","inProperty","dict","path","query","header","cookie","filterParams","methodParameters","pathParameters","res","paramNames","map","param","name","forEach","pathParam","includes","push","addFilesToJSONPropertyValidation","files","dataToValidate","data","file","fieldname","originalname","checkBody","req","requestBody","emptyBody","body","undefined","JSON","stringify","required","message","contentType","Object","keys","content","validSchema","cloneDeep","schema","fixNullable","toLowerCase","length","err","validate","error","getLastErrors","logger","info","getRequestProperty","location","requestLocation","find","key","checkParameter","params","errorMessages","i","in","currentParameter","nullable","Boolean","requestParameter","value","convertValue","getParameterType","code","registeredFormats","getRegisteredFormats","checkRequestData","oasDoc","requestedSpecPath","method","next","paths","keepGoing","msg","hasOwnProperty","methodParams","parameters","pathParams","concat","strict","customErrorHandling","Error","assign","failedValidation","validationResult","status","send","warn","locals","type","getParameterValue","parameter","defaultVal","default","paramLocation","val","headers","get","isUndefined","convertArrayValue","arrayValue","parse","Array","isArray","item","index","itemSchema","items","convertBooleanValue","convertNumberValue","numberValue","Number","isNaN","convertObjectValue","convertStringValue","format","date","Date","toString","optionalSchema","optionalType","allowEmptyValue","removeBasePath","reqRoutePath","split","filter","a","basePath","join","OASValidator","url","pathsDict","route","operation","swagger","pType","oVal","originalValue","debug"],"sources":["../../src/middleware/oas-validator.js"],"sourcesContent":["/*!\nOAS-tools module 0.0.0, built on: 2017-03-30\nCopyright (C) 2017 Ignacio Peluaga Lozada (ISA Group)\nhttps://github.com/ignpelloz\nhttps://github.com/isa-group/project-oas-tools\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.*/\n\nimport * as _ from \"lodash-compat\";\nimport * as utils from \"../lib/utils\";\nimport ZSchema from \"z-schema\";\nimport { config } from \"../configurations\";\nconst validator = new ZSchema({\n  ignoreUnresolvableReferences: true,\n  ignoreUnknownFormats: config.ignoreUnknownFormats,\n  breakOnFirstError: false,\n});\n\n/**\n * Returns the Express version of the OAS name for location.\n * @param {string} inProperty - Location of a parameter, value of 'in' property of the oasDoc file for that parameter.\n */\nfunction locationFormat(inProperty) {\n  //TODO: Possible 'in' values: path, query, header, cookie.\n  var dict = {\n    path: \"params\",\n    query: \"query\",\n    header: \"headers\",\n    cookie: \"cookie\",\n  };\n  return dict[inProperty];\n  //return (inProperty == \"path\" ? \"params\" : inProperty); //TODO: if only 'path' changes then this is the solution!\n}\n\n/**\n * Filters path parameters so that method parameters can override them\n * @param {*} methodParameters - Method-specific parameters\n * @param {*} pathParameters - Common parameters for every path method\n */\nfunction filterParams(methodParameters, pathParameters) {\n  var res = methodParameters;\n  var paramNames = methodParameters.map((param) => {\n    return param.name;\n  });\n  pathParameters.forEach((pathParam) => {\n    if (!paramNames.includes(pathParam.name)) {\n      res.push(pathParam);\n    }\n  });\n  return res;\n}\n\n/**\n * transfer fieldname(s) and filename(s) of an multipart/form-data request to a data object\n * that is subsequently passed to a validator checking for required properties of a openAPI path operation\n *\n * @param {array} files\n * @param {object} dataToValidate\n * @returns {object}\n */\nfunction addFilesToJSONPropertyValidation(files, dataToValidate) {\n  const data = dataToValidate;\n  files.forEach((file) => {\n    if (file.fieldname && file.originalname) {\n      data[file.fieldname] = file.originalname;\n    }\n  });\n  return data;\n}\n\nfunction checkBody(req, requestBody) {\n  const emptyBody = req.body == undefined || JSON.stringify(req.body) == \"{}\";\n  if (requestBody.required && emptyBody) {\n    return {\n      message: \"Missing object in the request body. \",\n    };\n  } else if (requestBody.required || !emptyBody) {\n    // can be any of \"application/json\", \"multipart/form-data\", \"image/png\", ...\n    const contentType = Object.keys(requestBody.content)[0];\n    var validSchema = _.cloneDeep(requestBody.content[contentType].schema);\n    utils.fixNullable(validSchema);\n\n    var data = req.body; //JSON.parse(req.body); //Without this everything is string so type validation wouldn't happen TODO: why is it commented?\n    // a multipart/form-data request has a \"files\" property in the request whose\n    // properties need to be passed to evaluating the required parameters in the openAPI spec\n    if (\n      contentType.toLowerCase() === \"multipart/form-data\" &&\n      req.files &&\n      req.files.length > 0\n    ) {\n      data = addFilesToJSONPropertyValidation(req.files, data);\n    }\n    var err = validator.validate(data, validSchema);\n    if (err == false) {\n      return {\n        message: \"Wrong data in the body of the request. \",\n        error: validator.getLastErrors(),\n        content: data,\n      };\n    }\n    config.logger.info(\"Valid parameter on request\");\n  }\n  return undefined;\n}\n\nfunction getRequestProperty(req, location, name) {\n  const requestLocation = req[location];\n  if (location === \"headers\") {\n    return requestLocation[\n      Object.keys(requestLocation).find(\n        (key) => key.toLowerCase() === name.toLowerCase()\n      )\n    ];\n  }\n  return requestLocation[name];\n}\n\nfunction checkParameter(req, params) {\n  const errorMessages = [];\n  for (var i = 0; i < params.length; i++) {\n    //TODO: 'required' property is not required, some parameters may not have it (those in query for example)\n\n    const { name, schema } = params[i];\n    const location = locationFormat(params[i].in);\n    const currentParameter = params[i];\n\n    const nullable =\n      currentParameter.nullable === undefined\n        ? false\n        : Boolean(currentParameter.nullable);\n    const required =\n      currentParameter.required === undefined\n        ? false\n        : Boolean(currentParameter.required);\n\n    const requestParameter = getRequestProperty(req, location, name);\n\n    if (requestParameter === undefined) {\n      if (required) {\n        errorMessages.push({\n          message: \"Missing parameter \" + name + \" in \" + location + \". \",\n        });\n      }\n    } else if (requestParameter === null) {\n      if (nullable === false) {\n        errorMessages.push({\n          message:\n            \"The parameter \" + name + \" in \" + location + \" cannot be null. \",\n        });\n      }\n    } else {\n      // In case the parameter is indeed present, check type. In the case of array, check also type of its items!\n      const value = convertValue(\n        requestParameter,\n        schema,\n        getParameterType(currentParameter),\n        currentParameter\n      );\n      const err = validator.validate(value, schema);\n      if (err == false) {\n        if (err.code == \"UNKNOWN_FORMAT\") {\n          var registeredFormats = ZSchema.getRegisteredFormats();\n          config.logger.error(\"UNKNOWN_FORMAT error - Registered Formats: \");\n          config.logger.error(registeredFormats);\n        }\n        errorMessages.push({\n          message: \"Wrong parameter \" + name + \" in \" + location + \". \",\n          error: validator.getLastErrors(),\n        });\n      } else {\n        config.logger.info(\"Valid parameter on request\");\n      }\n    }\n  }\n  return errorMessages;\n}\n\n/**\n * Checks if the data provided in the request is valid acording to what is specified in the oas specification file.\n * @param {object} paths - Paths section of the oasDoc file.\n * @param {string} requestedSpecPath - Requested url by the client. If the request had parameters in the query those won't be part of this variable.\n * @param {string} method - Method requested by the client.\n * @param {string} req - The whole req object from the client request.\n */\nfunction checkRequestData(oasDoc, requestedSpecPath, method, res, req, next) {\n  var paths = oasDoc.paths;\n  var keepGoing = true;\n  //var msg = \"\";\n  var msg = [];\n\n  if (paths[requestedSpecPath][method].hasOwnProperty(\"requestBody\")) {\n    const message = checkBody(\n      req,\n      paths[requestedSpecPath][method].requestBody\n    );\n    if (message !== undefined) {\n      msg.push(message);\n      keepGoing = false;\n    }\n  }\n\n  if (\n    paths[requestedSpecPath][method].hasOwnProperty(\"parameters\") ||\n    paths[requestedSpecPath].hasOwnProperty(\"parameters\")\n  ) {\n    const methodParams = paths[requestedSpecPath][method].parameters || [];\n    const pathParams = paths[requestedSpecPath].parameters || [];\n    const params = filterParams(methodParams, pathParams);\n    const errorMessages = checkParameter(req, params);\n    if (errorMessages.length !== 0) {\n      msg = msg.concat(errorMessages);\n      keepGoing = false;\n    }\n  }\n\n  if (keepGoing == false && config.strict == true) {\n    if (config.customErrorHandling) {\n      var error = new Error(\"Request validation error\");\n      Object.assign(error, {\n        failedValidation: true,\n        validationResult: msg,\n      });\n      next(error);\n    } else {\n      config.logger.error(JSON.stringify(msg));\n      res.status(400).send(msg);\n    }\n  } else {\n    if (msg.length != 0) {\n      config.logger.warn(JSON.stringify(msg));\n    }\n    res.locals.oasDoc = oasDoc;\n    next();\n  }\n}\n\n/**\n * .\n * @param {string}  - .\n */\nfunction getParameterType(schema) {\n  var type = schema.type;\n  if (!type && schema.schema) {\n    type = getParameterType(schema.schema);\n  }\n  if (!type) {\n    type = \"object\";\n  }\n  return type;\n}\n\n/**\n * .\n * @param {string}  - .\n\nfunction getParameterValue(req, parameter){ //TODO handle: body, form, formData, header, path, query... what about body?\n  var parameterName = parameter.name;\n  return req.params[parameterName];\n}\n*/\nfunction getParameterValue(req, parameter) {\n  var defaultVal = parameter.schema ? parameter.schema.default : undefined;\n  var paramLocation = parameter.in;\n  var val;\n\n  // Get the value to validate based on the operation parameter type\n  switch (paramLocation) {\n    case \"body\":\n      val = req.body;\n\n      break;\n    case \"form\":\n    case \"formData\":\n    case \"header\":\n      val = req.headers[parameter.name.toLowerCase()];\n\n      break;\n    case \"path\":\n      val = req.params[parameter.name]; // TODO: how many parameters can be in the path?\n\n      break;\n    case \"query\":\n      val = _.get(req.query, parameter.name);\n\n      break;\n  }\n  // Use the default value when necessary\n  if (_.isUndefined(val) && !_.isUndefined(defaultVal)) {\n    val = defaultVal;\n  }\n\n  return val;\n}\n\nfunction convertArrayValue(value, schema) {\n  let arrayValue;\n  if (typeof value === \"string\") {\n    try {\n      arrayValue = JSON.parse(value);\n      // Handle situation where the expected type is array but only one value was provided\n      if (Array.isArray(arrayValue) === false) {\n        return [value];\n      }\n    } catch (err) {\n      return value;\n    }\n  }\n\n  return arrayValue.map(value, (item, index) => {\n    const itemSchema = Array.isArray(schema.items)\n      ? schema.items[index]\n      : schema.items;\n\n    return convertValue(\n      item,\n      itemSchema,\n      itemSchema ? itemSchema.type : undefined\n    );\n  });\n}\n\nfunction convertBooleanValue(value) {\n  if (typeof value === \"boolean\") {\n    return value;\n  }\n  if (value === \"true\") {\n    return true;\n  }\n  if (value === \"false\") {\n    return false;\n  }\n  return value;\n}\n\nfunction convertNumberValue(value) {\n  if (typeof value !== \"string\") {\n    return value;\n  }\n  const numberValue = Number(value);\n  if (isNaN(numberValue)) {\n    return value;\n  }\n  return numberValue;\n}\n\nfunction convertObjectValue(value) {\n  if (typeof value !== \"string\") {\n    return value;\n  }\n  try {\n    return JSON.parse(value);\n  } catch (err) {\n    return value;\n  }\n}\n\nfunction convertStringValue(value, schema) {\n  if (typeof value !== \"string\") {\n    return value;\n  }\n\n  if ([\"date\", \"date-time\"].includes(schema.format)) {\n    const date = new Date(value);\n    if (date.toString() === \"Invalid Date\") {\n      return value;\n    }\n    return value;\n  }\n  return value;\n}\n\n/**\n * .\n * @param {string}  - .\n */\nfunction convertValue(value, optionalSchema, optionalType) {\n  // If there is no value, do not convert it\n  if (value === undefined) {\n    return value;\n  }\n  const schema = optionalSchema === undefined ? {} : optionalSchema;\n\n  // If there is an empty value and allowEmptyValue is true, return it\n  if (schema.allowEmptyValue && value === \"\") {\n    return value;\n  }\n  const type =\n    optionalType === undefined ? getParameterType(schema) : optionalType;\n\n  switch (type) {\n    case \"array\":\n      return convertArrayValue(value, schema);\n\n    case \"boolean\":\n      return convertBooleanValue(value);\n\n    case \"integer\":\n    case \"number\":\n      return convertNumberValue(value);\n\n    case \"object\":\n      return convertObjectValue(value);\n\n    case \"string\":\n    default:\n      return convertStringValue(value, schema);\n  }\n}\n\n/**\n * Subtracts the basePath of the requested path.\n * @param {string} reqRoutePath - Value of req.route.path.\n */\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nexport default (oasDoc) => {\n  return function OASValidator(req, res, next) {\n    var method = req.method.toLowerCase();\n\n    config.logger.info(\n      \"Requested method-url pair: \" + method + \" - \" + req.url\n    );\n\n    var requestedSpecPath = config.pathsDict[removeBasePath(req.route.path)];\n    var operation = oasDoc.paths[requestedSpecPath][method];\n\n    req.swagger = {\n      params: {},\n      operation: operation,\n    };\n\n    var methodParameters = operation.parameters || [];\n    var pathParameters = oasDoc.paths[requestedSpecPath].parameters || [];\n    var parameters = filterParams(methodParameters, pathParameters);\n    if (parameters != undefined) {\n      parameters.forEach((parameter) => {\n        // TODO: para POST y PUT el objeto se define en 'requestBody' y no en 'parameters'\n        var pType = getParameterType(parameter);\n        var oVal = getParameterValue(req, parameter);\n        var value = convertValue(\n          oVal,\n          parameter.schema == undefined ? parameter : parameter.schema,\n          pType\n        );\n\n        req.swagger.params[parameter.name] = {\n          // pgillis 2019 June 11\n\n          //path: \"/some/path\", //this shows the path to follow on the spec file to get to the parameter but oas-tools doesn't use it!\n          path: requestedSpecPath,\n          schema: parameter,\n          originalValue: oVal,\n          value: value,\n        };\n      });\n    }\n\n    var requestBody = operation.requestBody;\n    if (requestBody != undefined) {\n      // when and endpoint provides a file upload option and other properties,\n      // the content type changes to multipart/form-data\n      // other requestBody types such as \"image/png\" are allowed as well\n      // https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#considerations-for-file-uploads\n      const contentType = Object.keys(requestBody.content)[0];\n      req.swagger.params[requestBody[\"x-name\"]] = {\n        // pgillis 2019 June 11\n\n        //path: \"/some/path\", //this shows the path to follow on the spec file to get to the parameter but oas-tools doesn't use it!\n        path: requestedSpecPath,\n        schema: requestBody.content[contentType].schema,\n        originalValue: req.body,\n        value: req.body,\n      };\n\n      // inject possible file uploads\n      if (\n        contentType.toLowerCase() === \"multipart/form-data\" &&\n        req.files &&\n        req.files.length > 0\n      ) {\n        req.swagger.params[requestBody[\"x-name\"]].files = req.files;\n      }\n    }\n\n    res.locals.requestedSpecPath = requestedSpecPath;\n    config.logger.debug(\n      \"OASValidator  -res.locals.requestedSpecPath: \" +\n        res.locals.requestedSpecPath\n    );\n    checkRequestData(oasDoc, requestedSpecPath, method, res, req, next);\n  };\n};\n"],"mappings":"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"}