{"version":3,"file":"oas-router.mjs","names":["utils","MIMEtype","ZSchema","config","path","pkg","cloneDeep","validator","ignoreUnresolvableReferences","ignoreUnknownFormats","breakOnFirstError","getExpectedResponse","responses","code","resp","undefined","Math","floor","default","stripUndefinedKeys","data","maxDepth","Buffer","Object","getOwnPropertyNames","forEach","property","checkResponse","req","res","oldSend","oasDoc","method","requestedSpecPath","content","statusCode","explicitType","msg","logger","debug","JSON","stringify","responseCodeSection","paths","get","header","newErr","message","push","strict","error","apply","warn","hasOwnProperty","resultType","acceptTypes","headers","accept","split","map","type","trim","acceptType","mimeAccept","keys","contentType","firstMatch","secondMatch","mimeContent","subtype","length","status","essence","validSchema","schema","fixNullable","err","validate","parse","getLastErrors","substr","existsController","locationOfControllers","controllerName","require","join","info","getOpId","generateName","operationId","toString","toUpperCase","controllers","OASRouter","next","locals","toLowerCase","opID","controller","send","arguments"],"sources":["../../src/middleware/oas-router.js"],"sourcesContent":["/*!\nOAS-tools module 0.0.0, built on: 2017-03-30\nCopyright (C) 2017 Ignacio Peluaga Lozada (ISA Group)\nhttps://github.com/ignpelloz\nhttps://github.com/isa-group/project-oas-tools\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.*/\nimport * as utils from \"../lib/utils\";\nimport MIMEtype from \"whatwg-mimetype\";\nimport ZSchema from \"z-schema\";\nimport { config } from \"../configurations\";\nimport path from \"path\";\nimport pkg from \"lodash-compat\";\n\nconst { cloneDeep } = pkg;\nconst validator = new ZSchema({\n  ignoreUnresolvableReferences: true,\n  ignoreUnknownFormats: config.ignoreUnknownFormats,\n  breakOnFirstError: false,\n});\n\nfunction getExpectedResponse(responses, code) {\n  // Exact match wins over range definitions (1XX, 2XX, 3XX, 4XX, 5XX)\n  var resp = responses[code];\n  if (resp !== undefined) {\n    return resp;\n  }\n  resp = responses[Math.floor(code / 100) + \"XX\"];\n  if (resp !== undefined) {\n    return resp;\n  }\n  return responses.default;\n}\n\n/**\n * When an object carries keys whose values are \"undefined\" they fail the z-schema validation even though\n * when those objects are serialized to JSON those keys are never serialized which would effectively make\n * it pass the schema validation.\n * This method strips away (recursively) those undefined keys\n * NOTE: This method modifies the input!\n * @param data\n * @param maxDepth limits the recursion to avoid stack overflow when object references itself\n */\nfunction stripUndefinedKeys(data, maxDepth = 1024) {\n  if (\n    typeof data !== \"object\" ||\n    data === null ||\n    maxDepth <= 0 ||\n    data instanceof Buffer\n  ) {\n    return data;\n  }\n  Object.getOwnPropertyNames(data).forEach((property) => {\n    if (typeof data[property] === \"object\") {\n      stripUndefinedKeys(data[property], maxDepth - 1);\n    } else if (data[property] === undefined) {\n      delete data[property];\n    }\n  });\n  return data;\n}\n\n/**\n * Checks if the data sent as a response for the previous request matches the indicated in the specification file in the responses section for that request.\n * This function is used in the interception of the response sent by the controller to the client that made the request.\n * @param {object} req - req object of the request.\n * @param {object} res - res object of the request.\n * @param {object} oldSend - res object previous to interception.\n * @param {object} oasDoc - Specification file.\n * @param {object} method - Method requested by the client.\n * @param {object} requestedSpecPath - Requested path, as shown in the specification file: /resource/{parameter}\n * @param {object} content - Data sent from controller to client.\n */\nfunction checkResponse(\n  req,\n  res,\n  oldSend,\n  oasDoc,\n  method,\n  requestedSpecPath,\n  content\n) {\n  var code = res.statusCode;\n  var explicitType;\n  var msg = [];\n  var data = stripUndefinedKeys(content[0]);\n  config.logger.debug(\"Processing at checkResponse:\");\n  config.logger.debug(\"  -code: \" + code);\n  config.logger.debug(\"  -oasDoc: \" + JSON.stringify(oasDoc));\n  config.logger.debug(\"  -method: \" + method);\n  config.logger.debug(\"  -requestedSpecPath: \" + requestedSpecPath);\n  config.logger.debug(\"  -data: \" + JSON.stringify(data));\n  var responseCodeSection = getExpectedResponse(\n    oasDoc.paths[requestedSpecPath][method].responses,\n    code\n  ); //Section of the oasDoc file starting at a response code\n  if (res.get(\"content-type\") === undefined) {\n    res.header(\"Content-Type\", \"application/json;charset=utf-8\");\n  } else {\n    explicitType = new MIMEtype(res.get(\"content-type\"));\n  }\n  if (responseCodeSection === undefined) {\n    //if the code is undefined, data wont be checked as a status code is needed to retrieve 'schema' from the oasDoc file\n    var newErr = {\n      message: \"Wrong response code: \" + code,\n    };\n    msg.push(newErr);\n    if (config.strict === true) {\n      config.logger.error(JSON.stringify(msg));\n      content[0] = JSON.stringify(msg);\n      oldSend.apply(res, content);\n    } else {\n      config.logger.warn(JSON.stringify(msg));\n      oldSend.apply(res, content);\n    }\n  } else if (responseCodeSection.hasOwnProperty(\"content\")) {\n    var resultType;\n    var acceptTypes = [];\n    if (req.headers.accept) {\n      acceptTypes = req.headers.accept.split(\",\").map((type) => {\n        return type.trim();\n      });\n    }\n    acceptTypes.forEach((acceptType) => {\n      var mimeAccept = new MIMEtype(acceptType);\n      Object.keys(responseCodeSection.content).forEach((contentType) => {\n        if (!resultType) {\n          var firstMatch, secondMatch;\n          var mimeContent = new MIMEtype(contentType);\n\n          if (explicitType) {\n            firstMatch =\n              explicitType.type === mimeContent.type &&\n              (mimeAccept.type === mimeContent.type || mimeAccept.type === \"*\");\n            secondMatch =\n              explicitType.subtype === mimeContent.subtype &&\n              (mimeAccept.subtype === mimeContent.subtype ||\n                mimeAccept.subtype === \"*\");\n          } else {\n            firstMatch =\n              mimeAccept.type === mimeContent.type || mimeAccept.type === \"*\";\n            secondMatch =\n              mimeAccept.subtype === mimeContent.subtype ||\n              mimeAccept.subtype === \"*\";\n          }\n\n          if (firstMatch && secondMatch) {\n            resultType = mimeContent;\n          }\n        }\n      });\n    });\n    if (!resultType && acceptTypes.length === 0) {\n      resultType = new MIMEtype(\"application/json\");\n    } else if (!resultType && acceptTypes.length !== 0) {\n      newErr = {\n        message: \"No acceptable content type found.\",\n      };\n      msg.push(newErr);\n      content[0] = JSON.stringify(msg);\n      config.logger.error(content[0]);\n      res.status(406);\n    } else {\n      res.header(\"Content-Type\", resultType.essence + \";charset=utf-8\");\n    }\n    if (resultType && resultType.essence === \"application/json\") {\n      //if there is no content property for the given response then there is nothing to validate.\n      var validSchema = cloneDeep(\n        responseCodeSection.content[\"application/json\"].schema\n      );\n      utils.fixNullable(validSchema);\n\n      content[0] = JSON.stringify(content[0]);\n      config.logger.debug(\n        \"Schema to use for validation: \" + JSON.stringify(validSchema)\n      );\n      var err = validator.validate(JSON.parse(content[0]), validSchema);\n\n      if (err === false) {\n        newErr = {\n          message: \"Wrong data in the response. \",\n          error: validator.getLastErrors(),\n          content: data,\n        };\n        msg.push(newErr);\n        if (config.strict === true) {\n          config.logger.error(JSON.stringify(msg));\n          oldSend.apply(res, content);\n        } else {\n          config.logger.warn(\n            JSON.stringify(msg) + JSON.stringify(validator.getLastErrors())\n          );\n          if (\n            content[0].substr(0, 46) ===\n            '{\"message\":\"This is the mockup controller for '\n          ) {\n            config.logger.warn(\n              \"The used controller might not have been implemented\"\n            );\n          }\n          oldSend.apply(res, content);\n        }\n      } else {\n        oldSend.apply(res, content);\n      }\n    } else {\n      oldSend.apply(res, content);\n    }\n  } else {\n    oldSend.apply(res, content);\n  }\n}\n\n/**\n * Checks whether there is a standard controller (resouce+Controlle) in the location where the controllers are located or not.\n * @param {object} locationOfControllers - Location provided by the user where the controllers can be found.\n * @param {object} controllerName - Name of the controller: resource+'Controller'.\n */\nfunction existsController(locationOfControllers, controllerName) {\n  try {\n    require(path.join(locationOfControllers, controllerName));\n    return true;\n  } catch (err) {\n    config.logger.info(\n      \"The controller \" +\n        controllerName +\n        \" doesn't exist at \" +\n        locationOfControllers\n    );\n    return false;\n  }\n}\n\n/**\n * Returns an operationId. The retrieved one from the specification file or an automatically generated one if it was not specified.\n * @param {object} oasDoc - Specification file.\n * @param {object} requestedSpecPath - Requested path as shown in the specification file.\n * @param {object} method - Requested method.\n */\nfunction getOpId(oasDoc, requestedSpecPath, method) {\n  if (oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\"operationId\")) {\n    return utils.generateName(\n      oasDoc.paths[requestedSpecPath][method].operationId.toString(),\n      undefined\n    ); // Use opID specified in the oas doc\n  }\n  return (\n    utils.generateName(requestedSpecPath, \"function\") + method.toUpperCase()\n  );\n}\n\nexport default (controllers) => {\n  return function OASRouter(req, res, next) {\n    var oasDoc = res.locals.oasDoc;\n    var requestedSpecPath = res.locals.requestedSpecPath; //requested path version on the oasDoc file of the requested url\n    var method = req.method.toLowerCase();\n    var controllerName;\n\n    // pgillis 2019 Jun 10\n    // Handle case where the path has an x-swagger-router-controller.\n    //logger.debug(requestedSpecPath+ \" hasProperty \"+  oasDoc.paths[requestedSpecPath].hasOwnProperty('x-swagger-router-controller'));\n\n    if (\n      oasDoc.paths[requestedSpecPath].hasOwnProperty(\n        \"x-swagger-router-controller\"\n      ) &&\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-swagger-router-controller\"\n      ) === false\n    ) {\n      oasDoc.paths[requestedSpecPath][method] =\n        oasDoc.paths[requestedSpecPath][\"x-swagger-router-controller\"];\n    }\n    if (\n      oasDoc.paths[requestedSpecPath].hasOwnProperty(\"x-router-controller\") &&\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-router-controller\"\n      ) === false\n    ) {\n      oasDoc.paths[requestedSpecPath][method] =\n        oasDoc.paths[requestedSpecPath][\"x-router-controller\"];\n    }\n    // end pgillis\n\n    if (\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-swagger-router-controller\"\n      )\n    ) {\n      //oasDoc file has router_property: use the controller specified there\n      controllerName =\n        oasDoc.paths[requestedSpecPath][method][\"x-swagger-router-controller\"];\n    } else if (\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-router-controller\"\n      )\n    ) {\n      //oasDoc file has router_property: use the controller specified there\n      controllerName =\n        oasDoc.paths[requestedSpecPath][method][\"x-router-controller\"];\n    } else if (\n      existsController(\n        controllers,\n        utils.generateName(requestedSpecPath, \"controller\")\n      )\n    ) {\n      //oasDoc file doesn't have router_property: use the standard controller name (autogenerated) if found\n      controllerName = utils.generateName(requestedSpecPath, \"controller\");\n    } else {\n      //oasDoc file doesn't have router_property and standard controller (autogenerated name) doesn't exist: use the default controller\n      controllerName = \"Default\";\n    }\n\n    var opID = getOpId(oasDoc, requestedSpecPath, method);\n\n    var controller = require(path.join(controllers, controllerName));\n\n    var oldSend = res.send;\n    res.send = function send() {\n      //intercept the response from the controller to check and validate it\n      //Avoids res.send being executed twice: https://stackoverflow.com/questions/41489528/why-is-res-send-being-called-twice\n      checkResponse(\n        req,\n        res,\n        oldSend,\n        oasDoc,\n        method,\n        requestedSpecPath,\n        // eslint-disable-next-line prefer-rest-params\n        arguments\n      );\n    };\n    controller[opID].apply(undefined, [req, res, next]); // execute function by name\n  };\n};\n"],"mappings":"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"}